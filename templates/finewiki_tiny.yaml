graph:
  name: finewiki_qa_agent_longchain_branches_9nodes_tiny_06b_17b_4b_v1
  description: >
    Tiny long-chain + side-branch FineWiki QA workflow (9 LLM nodes).
    Uses very small models for fastest/cheapest runs:
    - Qwen/Qwen3-0.6B
    - Qwen/Qwen3-1.7B
    - Qwen/Qwen3-4B
    Each node has 0–2 DB queries, and all DB queries depend only on
    a single :keyword derived from user_query.

  nodes:
    - id: user_input
      type: input
      outputs:
        - user_query

    # ===== Main trunk (tiny) =====
    - id: global_topic_expander
      type: inference
      engine: vllm
      model: Qwen/Qwen3-4B
      db_queries:
        - name: fw_global_wikitext_fulltext
          sql: >
            SELECT page_id, title, url, wikitext
            FROM pages
            WHERE in_language = 'en'
              AND to_tsvector('english', coalesce(wikitext, ''))
                  @@ plainto_tsquery('english', :keyword)
            ORDER BY date_modified DESC
            LIMIT 40;
          parameters:
            keyword: "{{ user_query }}"
      system_prompt: |
        You are a global topic expander over a Wikipedia-like corpus.
        Use fw_global_wikitext_fulltext (and any other provided context)
        to build a broad but coherent summary of the topic and propose a
        small list of central candidate page_ids (as plain integers in text).
        Respond ONLY with:
        {
          "global_summary": "string",
          "central_page_ids": [integer, ...]
        }
      inputs:
        - user_query
      outputs:
        - global_summary
        - central_page_ids

    - id: timeline_refiner_1
      type: inference
      engine: vllm
      model: Qwen/Qwen3-1.7B
      db_queries:
        - name: fw_timeline_from_keyword
          sql: >
            SELECT page_id, title, url, wikitext, date_modified
            FROM pages
            WHERE in_language = 'en'
              AND to_tsvector('english', coalesce(wikitext, ''))
                  @@ plainto_tsquery('english', :keyword)
            ORDER BY date_modified ASC
            LIMIT 40;
          parameters:
            keyword: "{{ user_query }}"
      system_prompt: |
        You are a timeline-focused refiner.
        Given global_summary and central_page_ids, and using
        fw_timeline_from_keyword as context, construct a coarse
        chronological narrative of the topic.
        Keep it short and concrete.
        Respond ONLY with:
        {
          "coarse_timeline": "string"
        }
      inputs:
        - user_query
        - global_summary
        - central_page_ids
      outputs:
        - coarse_timeline

    - id: timeline_refiner_2
      type: inference
      engine: vllm
      model: Qwen/Qwen3-1.7B
      system_prompt: |
        You are a second-pass timeline refiner.
        Take the coarse_timeline and improve clarity and ordering, and
        highlight 3–5 key milestones.
        Respond ONLY with:
        {
          "refined_timeline": "string"
        }
      inputs:
        - user_query
        - coarse_timeline
      outputs:
        - refined_timeline

    # ===== Category branch (tiny) =====
    - id: category_overview
      type: inference
      engine: vllm
      model: Qwen/Qwen3-1.7B
      db_queries:
        - name: fw_category_pages
          sql: >
            SELECT page_id, title, url, wikitext
            FROM pages
            WHERE in_language = 'en'
              AND LOWER(title) LIKE LOWER('Category:%%' || :keyword || '%%')
            LIMIT 30;
          parameters:
            keyword: "{{ user_query }}"
      system_prompt: |
        You are a category-focused summarizer.
        Use fw_category_pages to provide a high-level taxonomy of the topic.
        Keep it compact.
        Respond ONLY with:
        {
          "category_overview": "string"
        }
      inputs:
        - user_query
      outputs:
        - category_overview

    - id: category_drilldown
      type: inference
      engine: vllm
      model: Qwen/Qwen3-0.6B
      system_prompt: |
        You are a drill-down assistant for category structures.
        From category_overview, extract 3–5 important subtopics that
        should be mentioned in a final answer.
        Respond ONLY with:
        {
          "category_details": ["string", ...]
        }
      inputs:
        - user_query
        - category_overview
      outputs:
        - category_details

    # ===== Link branch (tiny) =====
    - id: outbound_link_view
      type: inference
      engine: vllm
      model: Qwen/Qwen3-0.6B
      db_queries:
        - name: fw_outbound_links
          sql: >
            SELECT page_id, title, url, wikitext
            FROM pages
            WHERE in_language = 'en'
              AND title ILIKE '%%' || :keyword || '%%'
            ORDER BY page_id ASC
            LIMIT 40;
          parameters:
            keyword: "{{ user_query }}"
      system_prompt: |
        You are an outbound link summarizer.
        Given pages whose titles match user_query, summarize which topics
        they tend to link out to (based on their wikitext).
        Keep it short; list 5–10 link-topics if possible.
        Respond ONLY with:
        {
          "outbound_links_overview": "string"
        }
      inputs:
        - user_query
      outputs:
        - outbound_links_overview

    - id: inbound_link_view
      type: inference
      engine: vllm
      model: Qwen/Qwen3-0.6B
      system_prompt: |
        You summarize who links into this topic.
        Given outbound_links_overview and global_summary, infer which
        other pages/domains frequently point to this topic and why it matters.
        Use simple language.
        Respond ONLY with:
        {
          "inbound_links_overview": "string"
        }
      inputs:
        - user_query
        - outbound_links_overview
        - global_summary
      outputs:
        - inbound_links_overview

    # ===== Small helper + final head (tiny) =====
    - id: narrow_focus_rewriter
      type: inference
      engine: vllm
      model: Qwen/Qwen3-0.6B
      system_prompt: |
        Rewrite user_query into a narrower focus question suitable for
        a final answer. One sentence only.
        Respond ONLY with:
        {
          "narrowed_query": "string"
        }
      inputs:
        - user_query
      outputs:
        - narrowed_query

    - id: final_answer_summarizer
      type: inference
      engine: vllm
      model: Qwen/Qwen3-4B
      db_queries:
        - name: fw_supporting_snippets_global
          sql: >
            SELECT page_id, title, url, wikitext
            FROM pages
            WHERE in_language = 'en'
              AND to_tsvector('english', coalesce(wikitext, ''))
                  @@ plainto_tsquery('english', :keyword)
            ORDER BY date_modified DESC
            LIMIT 20;
          parameters:
            keyword: "{{ user_query }}"
      system_prompt: |
        You are the final answer assistant.
        Combine global_summary, refined_timeline, category_details,
        outbound_links_overview, inbound_links_overview, and narrowed_query
        (plus fw_supporting_snippets_global as loose background) into a single
        clear, grounded answer. Keep it concise.
        Respond ONLY with:
        {
          "final_answer": "string"
        }
      inputs:
        - user_query
        - global_summary
        - refined_timeline
        - category_details
        - outbound_links_overview
        - inbound_links_overview
        - narrowed_query
      outputs:
        - final_answer

  edges:
    # roots
    - from: user_input
      to: global_topic_expander
      mapping:
        user_query: "{{ user_query }}"

    - from: user_input
      to: category_overview
      mapping:
        user_query: "{{ user_query }}"

    - from: user_input
      to: outbound_link_view
      mapping:
        user_query: "{{ user_query }}"

    - from: user_input
      to: narrow_focus_rewriter
      mapping:
        user_query: "{{ user_query }}"

    # main chain
    - from: global_topic_expander
      to: timeline_refiner_1
      mapping:
        user_query: "{{ user_query }}"
        global_summary: "{{ global_summary }}"
        central_page_ids: "{{ central_page_ids }}"

    - from: timeline_refiner_1
      to: timeline_refiner_2
      mapping:
        user_query: "{{ user_query }}"
        coarse_timeline: "{{ coarse_timeline }}"

    # category branch
    - from: category_overview
      to: category_drilldown
      mapping:
        user_query: "{{ user_query }}"
        category_overview: "{{ category_overview }}"

    # link branch
    - from: outbound_link_view
      to: inbound_link_view
      mapping:
        user_query: "{{ user_query }}"
        outbound_links_overview: "{{ outbound_links_overview }}"

    - from: global_topic_expander
      to: inbound_link_view
      mapping:
        user_query: "{{ user_query }}"
        global_summary: "{{ global_summary }}"

    # final fusion
    - from: global_topic_expander
      to: final_answer_summarizer
      mapping:
        user_query: "{{ user_query }}"
        global_summary: "{{ global_summary }}"

    - from: timeline_refiner_2
      to: final_answer_summarizer
      mapping:
        user_query: "{{ user_query }}"
        refined_timeline: "{{ refined_timeline }}"

    - from: category_drilldown
      to: final_answer_summarizer
      mapping:
        user_query: "{{ user_query }}"
        category_details: "{{ category_details }}"

    - from: outbound_link_view
      to: final_answer_summarizer
      mapping:
        user_query: "{{ user_query }}"
        outbound_links_overview: "{{ outbound_links_overview }}"

    - from: inbound_link_view
      to: final_answer_summarizer
      mapping:
        user_query: "{{ user_query }}"
        inbound_links_overview: "{{ inbound_links_overview }}"

    - from: narrow_focus_rewriter
      to: final_answer_summarizer
      mapping:
        user_query: "{{ user_query }}"
        narrowed_query: "{{ narrowed_query }}"
