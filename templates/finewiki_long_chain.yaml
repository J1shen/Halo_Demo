graph:
  name: finewiki_qa_agent_longchain_branches_9nodes_3models
  description: >
    Long-chain + side-branch FineWiki QA workflow (9 LLM nodes).
    A long M_A chain (openai/gpt-oss-20b) progressively refines a global
    topic summary, while M_B (Qwen3-32B) and M_C (Qwen3-14B) branches
    provide category/link-based signals. A small M_S-style head and
    rewriter fuse everything into the final answer.
    Each node has 0–2 DB queries, and all DB queries depend only on
    a single :keyword derived from user_query.

  nodes:
    - id: user_input
      type: input
      outputs:
        - user_query

    # ===== M_A: 长链主干 (openai/gpt-oss-20b) =====
    - id: global_topic_expander
      type: inference
      engine: vllm
      model: openai/gpt-oss-20b
      db_queries:
        - name: fw_global_wikitext_fulltext
          sql: >
            SELECT page_id, title, url, wikitext
            FROM pages
            WHERE in_language = 'en'
              AND to_tsvector('english', coalesce(wikitext, ''))
                  @@ plainto_tsquery('english', :keyword)
            ORDER BY date_modified DESC
            LIMIT 40;
          parameters:
            keyword: "{{ user_query }}"
        - name: fw_global_title_keyword
          sql: >
            SELECT page_id, title, url, wikitext
            FROM pages
            WHERE in_language = 'en'
              AND title ILIKE '%%' || :keyword || '%%'
            ORDER BY date_modified DESC
            LIMIT 25;
          parameters:
            keyword: "{{ user_query }}"
      system_prompt: |
        You are a global topic expander over a Wikipedia-like corpus.
        Use fw_global_wikitext_fulltext and fw_global_title_keyword to build
        a broad but coherent summary of the topic and propose a small list
        of central candidate page_ids (as plain integers in text).
        Respond ONLY with:
        {
          "global_summary": "string",
          "central_page_ids": [integer, ...]
        }
      inputs:
        - user_query
      outputs:
        - global_summary
        - central_page_ids

    - id: timeline_refiner_1
      type: inference
      engine: vllm
      model: openai/gpt-oss-20b
      db_queries:
        - name: fw_timeline_from_keyword
          sql: >
            SELECT page_id, title, url, wikitext, date_modified
            FROM pages
            WHERE in_language = 'en'
              AND to_tsvector('english', coalesce(wikitext, ''))
                  @@ plainto_tsquery('english', :keyword)
            ORDER BY date_modified ASC
            LIMIT 40;
          parameters:
            keyword: "{{ user_query }}"
      system_prompt: |
        You are a timeline-focused refiner.
        Given global_summary and (textual) central_page_ids, and using
        fw_timeline_from_keyword as context, construct a coarse
        chronological narrative of the topic.
        Respond ONLY with:
        {
          "coarse_timeline": "string"
        }
      inputs:
        - user_query
        - global_summary
        - central_page_ids
      outputs:
        - coarse_timeline

    - id: timeline_refiner_2
      type: inference
      engine: vllm
      model: openai/gpt-oss-20b
      system_prompt: |
        You are a second-pass timeline refiner.
        Take the coarse_timeline and improve clarity and ordering, and
        highlight 3–5 key milestones.
        Respond ONLY with:
        {
          "refined_timeline": "string"
        }
      inputs:
        - user_query
        - coarse_timeline
      outputs:
        - refined_timeline

    # ===== M_B: category 分支 (Qwen/Qwen3-32B) =====
    - id: category_overview
      type: inference
      engine: vllm
      model: Qwen/Qwen3-32B
      db_queries:
        - name: fw_category_pages
          sql: >
            SELECT page_id, title, url, wikitext
            FROM pages
            WHERE in_language = 'en'
              AND LOWER(title) LIKE LOWER('Category:%%' || :keyword || '%%')
            LIMIT 30;
          parameters:
            keyword: "{{ user_query }}"
      system_prompt: |
        You are a category-focused summarizer.
        Use fw_category_pages to provide a high-level taxonomy of the topic.
        Respond ONLY with:
        {
          "category_overview": "string"
        }
      inputs:
        - user_query
      outputs:
        - category_overview

    - id: category_drilldown
      type: inference
      engine: vllm
      model: Qwen/Qwen3-32B
      system_prompt: |
        You are a drill-down assistant for category structures.
        Take category_overview and extract 3–5 important subtopics that
        should be mentioned in a final answer.
        Respond ONLY with:
        {
          "category_details": ["string", ...]
        }
      inputs:
        - user_query
        - category_overview
      outputs:
        - category_details

    # ===== M_C: link 分支 (Qwen/Qwen3-14B) =====
    - id: outbound_link_view
      type: inference
      engine: vllm
      model: Qwen/Qwen3-14B
      db_queries:
        - name: fw_outbound_links
          sql: >
            SELECT page_id, title, url, wikitext
            FROM pages
            WHERE in_language = 'en'
              AND title ILIKE '%%' || :keyword || '%%'
            ORDER BY page_id ASC
            LIMIT 40;
          parameters:
            keyword: "{{ user_query }}"
      system_prompt: |
        You are an outbound link summarizer.
        Given pages whose titles match user_query, summarize which topics
        they tend to link out to (based on their wikitext).
        Respond ONLY with:
        {
          "outbound_links_overview": "string"
        }
      inputs:
        - user_query
      outputs:
        - outbound_links_overview

    - id: inbound_link_view
      type: inference
      engine: vllm
      model: Qwen/Qwen3-14B
      system_prompt: |
        You summarize who links into this topic.
        Given outbound_links_overview and global_summary, infer which
        other pages or domains frequently point to this topic and why
        that matters for understanding it.
        Respond ONLY with:
        {
          "inbound_links_overview": "string"
        }
      inputs:
        - user_query
        - outbound_links_overview
        - global_summary
      outputs:
        - inbound_links_overview

    # ===== M_S-style helper + final head (using existing models) =====
    - id: narrow_focus_rewriter
      type: inference
      engine: vllm
      model: openai/gpt-oss-20b
      system_prompt: |
        You rewrite the user_query into a narrower focus question
        suitable for a final answer over this topic.
        Respond ONLY with:
        {
          "narrowed_query": "string"
        }
      inputs:
        - user_query
      outputs:
        - narrowed_query

    - id: final_answer_summarizer
      type: inference
      engine: vllm
      model: Qwen/Qwen3-14B
      db_queries:
        - name: fw_supporting_snippets_global
          sql: >
            SELECT page_id, title, url, wikitext
            FROM pages
            WHERE in_language = 'en'
              AND to_tsvector('english', coalesce(wikitext, ''))
                  @@ plainto_tsquery('english', :keyword)
            ORDER BY date_modified DESC
            LIMIT 20;
          parameters:
            keyword: "{{ user_query }}"
      system_prompt: |
        You are the final answer assistant.
        Combine global_summary, refined_timeline, category_details,
        outbound_links_overview, inbound_links_overview, and
        narrowed_query (plus fw_supporting_snippets_global as loose
        background) into a single clear, grounded answer.
        Respond ONLY with:
        {
          "final_answer": "string"
        }
      inputs:
        - user_query
        - global_summary
        - refined_timeline
        - category_details
        - outbound_links_overview
        - inbound_links_overview
        - narrowed_query
      outputs:
        - final_answer

  edges:
    # roots
    - from: user_input
      to: global_topic_expander
      mapping:
        user_query: "{{ user_query }}"

    - from: user_input
      to: category_overview
      mapping:
        user_query: "{{ user_query }}"

    - from: user_input
      to: outbound_link_view
      mapping:
        user_query: "{{ user_query }}"

    - from: user_input
      to: narrow_focus_rewriter
      mapping:
        user_query: "{{ user_query }}"

    # main chain
    - from: global_topic_expander
      to: timeline_refiner_1
      mapping:
        user_query: "{{ user_query }}"
        global_summary: "{{ global_summary }}"
        central_page_ids: "{{ central_page_ids }}"

    - from: timeline_refiner_1
      to: timeline_refiner_2
      mapping:
        user_query: "{{ user_query }}"
        coarse_timeline: "{{ coarse_timeline }}"

    # category branch
    - from: category_overview
      to: category_drilldown
      mapping:
        user_query: "{{ user_query }}"
        category_overview: "{{ category_overview }}"

    # link branch
    - from: outbound_link_view
      to: inbound_link_view
      mapping:
        user_query: "{{ user_query }}"
        outbound_links_overview: "{{ outbound_links_overview }}"

    - from: global_topic_expander
      to: inbound_link_view
      mapping:
        user_query: "{{ user_query }}"
        global_summary: "{{ global_summary }}"

    # final fusion
    - from: global_topic_expander
      to: final_answer_summarizer
      mapping:
        user_query: "{{ user_query }}"
        global_summary: "{{ global_summary }}"

    - from: timeline_refiner_2
      to: final_answer_summarizer
      mapping:
        user_query: "{{ user_query }}"
        refined_timeline: "{{ refined_timeline }}"

    - from: category_drilldown
      to: final_answer_summarizer
      mapping:
        user_query: "{{ user_query }}"
        category_details: "{{ category_details }}"

    - from: outbound_link_view
      to: final_answer_summarizer
      mapping:
        user_query: "{{ user_query }}"
        outbound_links_overview: "{{ outbound_links_overview }}"

    - from: inbound_link_view
      to: final_answer_summarizer
      mapping:
        user_query: "{{ user_query }}"
        inbound_links_overview: "{{ inbound_links_overview }}"

    - from: narrow_focus_rewriter
      to: final_answer_summarizer
      mapping:
        user_query: "{{ user_query }}"
        narrowed_query: "{{ narrowed_query }}"
