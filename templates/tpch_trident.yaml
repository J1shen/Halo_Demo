graph:
  name: tpch_qbench_trident_rules_v1
  description: >
    TPC-H Q1–Q22-aligned workflow with RULE-BASED parameter extraction.
    No LLM parameter parsing.
    A deterministic rule node extracts structured parameters from user_query
    using regex + dictionaries, then downstream DB nodes use those parameters
    in Q1–Q22-style queries.

  nodes:
    - id: user_input
      type: input
      outputs:
        - user_query

    # ===== 1) deterministic param extraction (NO LLM) =====
    - id: rule_param_extractor
      type: processor
      processor: regex_param_extractor
      config:
        # ---- Dictionaries for canonicalization (case-insensitive) ----
        enums:
          region: ["AFRICA","AMERICA","ASIA","EUROPE","MIDDLE EAST"]
          segment: ["AUTOMOBILE","BUILDING","FURNITURE","HOUSEHOLD","MACHINERY"]
          shipmode: ["AIR","AIR REG","RAIL","SHIP","TRUCK","MAIL","FOB"]
          orderpriority_prefix: ["1-URGENT","2-HIGH","3-MEDIUM","4-NOT SPECIFIED","5-LOW"]

        # ---- Regex rules (first match wins per field unless allow_multi) ----
        regex:
          # dates: accept YYYY-MM-DD or YYYY/MM/DD
          date:
            - "(?i)\\bdate\\s*[=:]\\s*([0-9]{4}[-/][0-9]{2}[-/][0-9]{2})\\b"
            - "(?i)\\bafter\\s+([0-9]{4}[-/][0-9]{2}[-/][0-9]{2})\\b"
            - "(?i)\\bbefore\\s+([0-9]{4}[-/][0-9]{2}[-/][0-9]{2})\\b"
          date2:
            - "(?i)\\bdate2\\s*[=:]\\s*([0-9]{4}[-/][0-9]{2}[-/][0-9]{2})\\b"
            - "(?i)\\bto\\s+([0-9]{4}[-/][0-9]{2}[-/][0-9]{2})\\b"

          # years
          year:
            - "(?i)\\byear\\s*[=:]\\s*(199[2-8])\\b"
            - "(?i)\\b(199[2-8])\\b"
          year2:
            - "(?i)\\byear2\\s*[=:]\\s*(199[2-8])\\b"
            - "(?i)\\bbetween\\s+(199[2-8])\\s+and\\s+(199[2-8])\\b"  # you can map to year/year2 in code

          # region / nation / segment
          region:
            - "(?i)\\bregion\\s*[=:]\\s*([A-Z][A-Z ]+?)\\b"
            - "(?i)\\b(AF(RICA)?|AMERICA|ASIA|EUROPE|MIDDLE\\s+EAST)\\b"
          nation:
            - "(?i)\\bnation\\s*[=:]\\s*([A-Z][A-Z ]+?)\\b"
            - "(?i)\\b(JAPAN|CHINA|INDIA|FRANCE|GERMANY|CANADA|BRAZIL|UNITED\\s+STATES|RUSSIA)\\b"
          nation2:
            - "(?i)\\bnation2\\s*[=:]\\s*([A-Z][A-Z ]+?)\\b"
            - "(?i)\\bvs\\s+([A-Z][A-Z ]+?)\\b"

          segment:
            - "(?i)\\bsegment\\s*[=:]\\s*(AUTOMOBILE|BUILDING|FURNITURE|HOUSEHOLD|MACHINERY)\\b"
            - "(?i)\\b(AUTOMOBILE|BUILDING|FURNITURE|HOUSEHOLD|MACHINERY)\\b"

          # part filters
          brand:
            - "(?i)\\bbrand\\s*[=:]\\s*(Brand#[0-9]{2})\\b"
            - "(?i)\\b(Brand#[0-9]{2})\\b"
          type:
            - "(?i)\\btype\\s*[=:]\\s*([A-Za-z0-9_\\- ]{3,30})\\b"
          size:
            - "(?i)\\bsize\\s*[=:]\\s*([0-9]{1,3})\\b"

          # ops filters
          shipmode:
            - "(?i)\\bshipmode\\s*[=:]\\s*(AIR\\s+REG|AIR|RAIL|SHIP|TRUCK|MAIL|FOB)\\b"
            - "(?i)\\b(AIR\\s+REG|AIR|RAIL|SHIP|TRUCK|MAIL|FOB)\\b"
          shipmode2:
            - "(?i)\\bshipmode2\\s*[=:]\\s*(AIR\\s+REG|AIR|RAIL|SHIP|TRUCK|MAIL|FOB)\\b"
          discount_lo:
            - "(?i)\\bdiscount\\s*[=:]\\s*([0-9]*\\.?[0-9]+)\\b"     # "discount=0.05" -> lo
            - "(?i)\\bdiscount_lo\\s*[=:]\\s*([0-9]*\\.?[0-9]+)\\b"
          discount_hi:
            - "(?i)\\bdiscount_hi\\s*[=:]\\s*([0-9]*\\.?[0-9]+)\\b"
          qty:
            - "(?i)\\bqty\\s*[<=>:]\\s*([0-9]{1,4})\\b"
            - "(?i)\\bquantity\\s*[<=>:]\\s*([0-9]{1,4})\\b"

        # ---- Defaults (TPC-H-ish) ----
        defaults:
          year: 1994
          region: "ASIA"
          segment: "BUILDING"
          shipmode: "MAIL"
          shipmode2: "SHIP"
          date: "1995-03-15"
          discount_lo: 0.05
          discount_hi: 0.07
          qty: 24
          size: 15
          type: "BRASS"
          brand: "Brand#13"
          nation: "CANADA"
          nation2: "GERMANY"

        # ---- Normalizers (implemented in your processor) ----
        normalize:
          uppercase_fields: ["region","nation","nation2","segment","shipmode","shipmode2","brand"]
          date_fields: ["date","date2"]
          numeric_fields: ["year","year2","size","qty","discount_lo","discount_hi"]
          strip_quotes: true
      inputs:
        - user_query
      outputs:
        - tpch_params

    # ===== 2–4) entry fan-out =====

    - id: entry_q1_q6_lineitem
      type: inference
      engine: vllm
      model: Qwen/Qwen3-14B
      db_queries:
        - name: tpch_q1_pricing_summary
          sql: >
            SELECT
              l_returnflag, l_linestatus,
              SUM(l_quantity) AS sum_qty,
              SUM(l_extendedprice) AS sum_base_price,
              SUM(l_extendedprice * (1 - l_discount)) AS sum_disc_price,
              SUM(l_extendedprice * (1 - l_discount) * (1 + l_tax)) AS sum_charge,
              AVG(l_quantity) AS avg_qty,
              AVG(l_extendedprice) AS avg_price,
              AVG(l_discount) AS avg_disc,
              COUNT(*) AS count_order
            FROM lineitem
            WHERE l_shipdate <= (COALESCE(NULLIF(:date::text, 'sample')::date, DATE '1995-03-15') - INTERVAL '90 day')
            GROUP BY l_returnflag, l_linestatus
            ORDER BY l_returnflag, l_linestatus;
          parameters:
            date: "{{ tpch_params.date }}"
          param_types:
            date: date

        - name: tpch_q6_revenue_change
          sql: >
            SELECT SUM(l_extendedprice * l_discount) AS revenue
            FROM lineitem
            WHERE l_shipdate >= make_date(:year::int, 1, 1)
              AND l_shipdate <  make_date(:year::int, 1, 1) + INTERVAL '1 year'
              AND l_discount BETWEEN :discount_lo::numeric AND :discount_hi::numeric
              AND l_quantity < :qty::numeric;
          parameters:
            year: "{{ tpch_params.year }}"
            discount_lo: "{{ tpch_params.discount_lo }}"
            discount_hi: "{{ tpch_params.discount_hi }}"
            qty: "{{ tpch_params.qty }}"
          param_types:
            year: int
            discount_lo: numeric
            discount_hi: numeric
            qty: numeric
      system_prompt: |
        Entry A: Summarize Q1 + Q6 outputs and connect them to user_query.
        Respond ONLY with: { "entry_lineitem_notes": "string" }
      inputs: [user_query, tpch_params]
      outputs: [entry_lineitem_notes]

    - id: entry_q3_q5_revenue
      type: inference
      engine: vllm
      model: openai/gpt-oss-20b
      db_queries:
        - name: tpch_q3_shipping_priority
          sql: >
            SELECT
              l.l_orderkey,
              SUM(l.l_extendedprice * (1 - l.l_discount)) AS revenue,
              o.o_orderdate,
              o.o_shippriority
            FROM customer c
            JOIN orders o ON o.o_custkey = c.c_custkey
            JOIN lineitem l ON l.l_orderkey = o.o_orderkey
            WHERE c.c_mktsegment = :segment
              AND o.o_orderdate < COALESCE(NULLIF(:date::text, 'sample')::date, DATE '1995-03-15')
              AND l.l_shipdate > COALESCE(NULLIF(:date::text, 'sample')::date, DATE '1995-03-15')
            GROUP BY l.l_orderkey, o.o_orderdate, o.o_shippriority
            ORDER BY revenue DESC, o.o_orderdate
            LIMIT 20;
          parameters:
            segment: "{{ tpch_params.segment }}"
            date: "{{ tpch_params.date }}"
          param_types:
            segment: text
            date: date

        - name: tpch_q5_local_supplier_volume
          sql: >
            SELECT n.n_name AS nation,
                   SUM(l.l_extendedprice * (1 - l.l_discount)) AS revenue
            FROM customer c
            JOIN orders o ON o.o_custkey = c.c_custkey
            JOIN lineitem l ON l.l_orderkey = o.o_orderkey
            JOIN supplier s ON s.s_suppkey = l.l_suppkey
            JOIN nation n ON n.n_nationkey = s.s_nationkey
            JOIN region r ON r.r_regionkey = n.n_regionkey
            WHERE r.r_name = :region
              AND o.o_orderdate >= make_date(:year::int, 1, 1)
              AND o.o_orderdate <  make_date(:year::int, 1, 1) + INTERVAL '1 year'
            GROUP BY n.n_name
            ORDER BY revenue DESC
            LIMIT 25;
          parameters:
            region: "{{ tpch_params.region }}"
            year: "{{ tpch_params.year }}"
          param_types:
            region: text
            year: int
      system_prompt: |
        Entry B: Summarize Q3 + Q5 outputs and connect them to user_query.
        Respond ONLY with: { "entry_revenue_notes": "string" }
      inputs: [user_query, tpch_params]
      outputs: [entry_revenue_notes]

    - id: entry_q2_q9_supply
      type: inference
      engine: vllm
      model: Qwen/Qwen3-32B
      db_queries:
        - name: tpch_q2_min_cost_supplier
          sql: >
            SELECT s.s_acctbal, s.s_name, n.n_name AS nation,
                   p.p_partkey, p.p_mfgr, ps.ps_supplycost
            FROM part p
            JOIN partsupp ps ON ps.ps_partkey = p.p_partkey
            JOIN supplier s ON s.s_suppkey = ps.ps_suppkey
            JOIN nation n ON n.n_nationkey = s.s_nationkey
            JOIN region r ON r.r_regionkey = n.n_regionkey
            WHERE r.r_name = :region
              AND p.p_size = :size::int
              AND p.p_type ILIKE '%' || :type || '%'
              AND ps.ps_supplycost = (
                SELECT MIN(ps2.ps_supplycost)
                FROM partsupp ps2
                JOIN supplier s2 ON s2.s_suppkey = ps2.ps_suppkey
                JOIN nation n2 ON n2.n_nationkey = s2.s_nationkey
                JOIN region r2 ON r2.r_regionkey = n2.n_regionkey
                WHERE r2.r_name = :region AND ps2.ps_partkey = p.p_partkey
              )
            ORDER BY s.s_acctbal DESC, n.n_name, s.s_name
            LIMIT 20;
          parameters:
            region: "{{ tpch_params.region }}"
            size: "{{ tpch_params.size }}"
            type: "{{ tpch_params.type }}"
          param_types:
            region: text
            size: int
            type: text

        - name: tpch_q9_profit
          sql: >
            SELECT n.n_name AS nation,
                   EXTRACT(YEAR FROM o.o_orderdate)::int AS year,
                   SUM(l.l_extendedprice * (1 - l.l_discount) - ps.ps_supplycost * l.l_quantity) AS profit
            FROM part p
            JOIN lineitem l ON l.l_partkey = p.p_partkey
            JOIN orders o ON o.o_orderkey = l.l_orderkey
            JOIN partsupp ps ON ps.ps_partkey = l.l_partkey AND ps.ps_suppkey = l.l_suppkey
            JOIN supplier s ON s.s_suppkey = l.l_suppkey
            JOIN nation n ON n.n_nationkey = s.s_nationkey
            WHERE p.p_brand = :brand
            GROUP BY n.n_name, year
            ORDER BY nation, year
            LIMIT 60;
          parameters:
            brand: "{{ tpch_params.brand }}"
          param_types:
            brand: text
      system_prompt: |
        Entry C: Summarize Q2 + Q9 outputs and connect them to user_query.
        Respond ONLY with: { "entry_supply_notes": "string" }
      inputs: [user_query, tpch_params]
      outputs: [entry_supply_notes]

    # ===== 5–6) hubs =====

    - id: hub_ops_openai20b
      type: inference
      engine: vllm
      model: openai/gpt-oss-20b
      db_queries:
        - name: tpch_q12_shipmode_priority
          sql: >
            SELECT l.l_shipmode,
                   SUM(CASE WHEN o.o_orderpriority IN ('1-URGENT','2-HIGH') THEN 1 ELSE 0 END) AS high_line_count,
                   SUM(CASE WHEN o.o_orderpriority NOT IN ('1-URGENT','2-HIGH') THEN 1 ELSE 0 END) AS low_line_count
            FROM orders o
            JOIN lineitem l ON l.l_orderkey = o.o_orderkey
            WHERE l.l_shipmode IN (:shipmode, :shipmode2)
              AND l.l_commitdate < l.l_receiptdate
              AND l.l_shipdate < l.l_commitdate
              AND l.l_receiptdate >= make_date(:year::int, 1, 1)
              AND l.l_receiptdate <  make_date(:year::int, 1, 1) + INTERVAL '1 year'
            GROUP BY l.l_shipmode
            ORDER BY l.l_shipmode;
          parameters:
            shipmode: "{{ tpch_params.shipmode }}"
            shipmode2: "{{ tpch_params.shipmode2 }}"
            year: "{{ tpch_params.year }}"
          param_types:
            shipmode: text
            shipmode2: text
            year: int
      system_prompt: |
        Hub1: fuse entry_lineitem_notes + entry_revenue_notes with Q12 anchor.
        Respond ONLY with: { "hub_ops_notes": "string" }
      inputs: [user_query, tpch_params, entry_lineitem_notes, entry_revenue_notes]
      outputs: [hub_ops_notes]

    - id: hub_full_context_qwen14b
      type: inference
      engine: vllm
      model: Qwen/Qwen3-14B
      db_queries:
        - name: tpch_q14_promo_revenue
          sql: >
            SELECT
              100.00 * SUM(CASE WHEN p.p_type LIKE 'PROMO%' THEN l.l_extendedprice * (1 - l.l_discount) ELSE 0 END)
              / SUM(l.l_extendedprice * (1 - l.l_discount)) AS promo_revenue
            FROM lineitem l
            JOIN part p ON p.p_partkey = l.l_partkey
            WHERE l.l_shipdate >= make_date(:year::int, 9, 1)
              AND l.l_shipdate <  make_date(:year::int, 10, 1);
          parameters:
            year: "{{ tpch_params.year }}"
          param_types:
            year: int
      system_prompt: |
        Hub2: combine hub_ops_notes + entry_supply_notes with Q14 promo anchor.
        Respond ONLY with: { "hub_full_context": "string" }
      inputs: [user_query, tpch_params, hub_ops_notes, entry_supply_notes]
      outputs: [hub_full_context]

    # ===== 7) tail =====
    - id: tail_focus_qwen32b
      type: inference
      engine: vllm
      model: Qwen/Qwen3-32B
      system_prompt: |
        Tail: based on hub_full_context, recommend 4–6 next TPC-H queries to run
        and which params to refine (year/date/region/nation/segment/brand/shipmode/discount/qty/size/type).
        Respond ONLY with: { "tail_focus_notes": "string" }
      inputs: [user_query, hub_full_context]
      outputs: [tail_focus_notes]

    # ===== 8) final =====
    - id: tpch_final_answer
      type: inference
      engine: vllm
      model: openai/gpt-oss-20b
      db_queries:
        - name: tpch_q15_top_supplier
          sql: >
            WITH revenue0 AS (
              SELECT l.l_suppkey AS supplier_no,
                     SUM(l.l_extendedprice * (1 - l.l_discount)) AS total_revenue
              FROM lineitem l
              WHERE l.l_shipdate >= make_date(:year::int, 1, 1)
                AND l.l_shipdate <  make_date(:year::int, 4, 1)
              GROUP BY l.l_suppkey
            )
            SELECT s.s_suppkey, s.s_name, r.total_revenue
            FROM supplier s
            JOIN revenue0 r ON r.supplier_no = s.s_suppkey
            WHERE r.total_revenue = (SELECT MAX(total_revenue) FROM revenue0)
            ORDER BY s.s_suppkey;
          parameters:
            year: "{{ tpch_params.year }}"
          param_types:
            year: int
      system_prompt: |
        Final: use tpch_params + hub_full_context + tail_focus_notes + Q15 output
        to produce final_answer grounded in the DB results.
        Respond ONLY with: { "final_answer": "string" }
      inputs: [user_query, tpch_params, hub_full_context, tail_focus_notes]
      outputs: [final_answer]

  edges:
    - from: user_input
      to: rule_param_extractor
      mapping:
        user_query: "{{ user_query }}"

    - from: rule_param_extractor
      to: entry_q1_q6_lineitem
      mapping:
        user_query: "{{ user_query }}"
        tpch_params: "{{ tpch_params }}"

    - from: rule_param_extractor
      to: entry_q3_q5_revenue
      mapping:
        user_query: "{{ user_query }}"
        tpch_params: "{{ tpch_params }}"

    - from: rule_param_extractor
      to: entry_q2_q9_supply
      mapping:
        user_query: "{{ user_query }}"
        tpch_params: "{{ tpch_params }}"

    - from: entry_q1_q6_lineitem
      to: hub_ops_openai20b
      mapping:
        user_query: "{{ user_query }}"
        tpch_params: "{{ tpch_params }}"
        entry_lineitem_notes: "{{ entry_lineitem_notes }}"

    - from: entry_q3_q5_revenue
      to: hub_ops_openai20b
      mapping:
        user_query: "{{ user_query }}"
        tpch_params: "{{ tpch_params }}"
        entry_revenue_notes: "{{ entry_revenue_notes }}"

    - from: hub_ops_openai20b
      to: hub_full_context_qwen14b
      mapping:
        user_query: "{{ user_query }}"
        tpch_params: "{{ tpch_params }}"
        hub_ops_notes: "{{ hub_ops_notes }}"

    - from: entry_q2_q9_supply
      to: hub_full_context_qwen14b
      mapping:
        user_query: "{{ user_query }}"
        tpch_params: "{{ tpch_params }}"
        entry_supply_notes: "{{ entry_supply_notes }}"

    - from: hub_full_context_qwen14b
      to: tail_focus_qwen32b
      mapping:
        user_query: "{{ user_query }}"
        hub_full_context: "{{ hub_full_context }}"

    - from: hub_full_context_qwen14b
      to: tpch_final_answer
      mapping:
        user_query: "{{ user_query }}"
        tpch_params: "{{ tpch_params }}"
        hub_full_context: "{{ hub_full_context }}"

    - from: tail_focus_qwen32b
      to: tpch_final_answer
      mapping:
        user_query: "{{ user_query }}"
        tpch_params: "{{ tpch_params }}"
        tail_focus_notes: "{{ tail_focus_notes }}"
